# 诗词接龙游戏 - 实现规格说明

## 1. 概述

诗词接龙游戏是一个基于无限方格的填字游戏，玩家通过共享汉字连接诗句，形成纵横交错的诗词版图。核心机制是点击已有诗句的任意汉字作为连接点，选择方向后输入新诗句，系统实时验证连接有效性，确认后将诗句固定到版图。游戏支持拖拽平移、滚轮缩放、历史记录等交互，采用简约白色风格，初始自动生成首句"春江潮水连海平"。

## 2. 页面与模块

### 2.1 主页面（单页面应用）
- **用途**：游戏的主视图，包含无限方格画布和所有UI控制面板

### 2.2 左上角控制面板
- **用途**：显示游戏状态、统计信息、全局控制按钮
- **组件**：
  - 标题：诗词接龙
  - 当前状态标签（动态显示）
  - 回合数显示
  - 诗句数统计
  - 重置视图按钮
  - 清空所有按钮

### 2.3 右上角历史记录面板
- **用途**：显示已放置诗句的历史记录，按回合倒序排列
- **组件**：
  - 标题：历史记录
  - 列表项（每条包含：回合号 + 方向图标 + 诗句内容）

### 2.4 底部草稿操作栏（条件显示）
- **用途**：草稿模式下的输入和操作控制
- **组件**：
  - 输入框
  - 旋转按钮（↻ 旋转）
  - 取消按钮
  - 确认按钮（主操作按钮）

### 2.5 主视图画布
- **用途**：渲染无限方格、诗句、草稿预览、方向选择器
- **组件**：
  - 无限方格背景
  - 诗句渲染层
  - 草稿预览层
  - 方向选择器
  - 提示信息层

## 3. 主流程

### 3.1 游戏启动流程
1. 打开应用
2. 初始化数据结构（空数组、空Map）
3. 自动生成首句"春江潮水连海平"（横向，x=0, y=0）
4. 设置回合数为1，诗句数为1
5. 视角聚焦到首句中心位置
6. 显示状态标签为"选择连接点"
7. 隐藏底部草稿操作栏

### 3.2 放置新诗句流程
1. **选择连接点阶段**：
   - 鼠标悬停在已有诗句的任意汉字上
   - 显示方向选择器（上下左右四个箭头按钮围绕该字）
   - 点击某个方向箭头

2. **进入草稿模式阶段**：
   - 隐藏方向选择器
   - 状态标签更新为"编辑诗句"
   - 显示底部草稿操作栏
   - 视角自动聚焦到连接点位置
   - 输入框自动获取焦点
   - 输入框内容为空

3. **输入诗句阶段**：
   - 在输入框中输入诗句
   - 实时在方格中渲染草稿预览（黄色背景）
   - 系统根据当前连接点和方向计算草稿位置
   - 默认offset=0（连接点在诗句首字）

4. **验证与调整阶段**：
   - 系统实时验证：检查重合点字符是否一致
   - 有效重合字显示绿色高亮
   - 冲突字显示红色高亮
   - 无重合点或全是已有字时确认按钮禁用
   - 拖动草稿预览可调整offset

5. **确认提交阶段**：
   - 点击确认按钮
   - 验证通过：
     - 将草稿诗句添加到poems数组
     - 更新cells Map
     - 回合数+1，诗句数+1
     - 更新历史记录列表
     - 退出草稿模式
     - 状态标签更新为"选择连接点"
     - 隐藏底部草稿操作栏
   - 验证失败：保持草稿模式

### 3.3 取消草稿流程
1. 在草稿模式下点击取消按钮
2. 清空草稿数据
3. 清空预览渲染
4. 隐藏底部草稿操作栏
5. 状态标签更新为"选择连接点"

### 3.4 地图操作流程
1. **平移**：鼠标左键拖拽画布移动视角（草稿模式下禁用）
2. **缩放**：鼠标滚轮缩放，范围0.3x-3x，以鼠标位置为中心
3. **重置**：点击重置视图按钮，视角回到最后放置诗句中心或初始中心

## 4. 关键交互与状态

### 4.1 状态标签
- **选择连接点**：非草稿模式下的默认状态
- **编辑诗句**：草稿模式下的状态

### 4.2 方向选择器
- **触发条件**：鼠标悬停在已有诗句的任意汉字上
- **显示位置**：围绕该汉字的四个方向（上、下、左、右各显示一个箭头按钮）
- **点击行为**：点击箭头后进入草稿模式，方向为箭头指向方向
- **消失条件**：鼠标移开汉字、进入草稿模式

### 4.3 输入框
- **位置**：底部草稿操作栏中央
- **默认内容**：空字符串
- **属性**：placeholder="输入诗句..."，maxlength=20
- **输入过滤**：允许输入中文、标点、空格，自动trim处理
- **实时行为**：输入时实时更新草稿预览

### 4.4 旋转按钮
- **标签**："↻ 旋转"
- **位置**：底部草稿操作栏，输入框右侧
- **行为**：点击后切换草稿方向（横向↔纵向）
- **状态影响**：切换后重新计算草稿位置并渲染预览

### 4.5 取消按钮
- **标签**："取消"
- **位置**：底部草稿操作栏，输入框左侧
- **行为**：点击后退出草稿模式，不保存任何更改

### 4.6 确认按钮
- **标签**："确认"
- **位置**：底部草稿操作栏，输入框右侧
- **样式**：primary（高亮样式）
- **默认状态**：禁用（灰色不可点击）
- **启用条件**：
  - 输入不为空
  - 存在至少1个重合点
  - 所有重合点字符一致
  - 至少包含1个新字（不全是已有字）
- **行为**：点击后验证并提交诗句

### 4.7 重置视图按钮
- **标签**："重置视图"
- **位置**：左上角控制面板
- **行为**：点击后视角回到最后放置诗句中心（如有）或初始中心（-100000 + viewport/2）

### 4.8 清空所有按钮
- **标签**："清空所有"
- **位置**：左上角控制面板
- **行为**：
  - 第一次点击：弹出确认对话框"确定要清空所有诗句吗？"
  - 第二次点击确认：重置游戏到初始状态（保留首句"春江潮水连海平"）
  - 点击取消：关闭对话框，不执行清空

### 4.9 视觉反馈颜色
- **已确认诗句背景**：白色
- **已确认诗句边框**：灰色
- **草稿预览背景**：黄色
- **有效重合字**：绿色高亮
- **冲突字**：红色高亮
- **连接锚点**：蓝色边框高亮
- **无限方格网格线**：浅灰色

### 4.10 错误提示
- **冲突提示**：重合位置字符不一致时，冲突字显示红色高亮
- **无重合点提示**：输入诗句后无重合点时，确认按钮保持禁用状态
- **全是已有字提示**：输入诗句全是已有字时，确认按钮保持禁用状态
- **空输入提示**：输入框为空时，草稿预览清空，确认按钮保持禁用状态

### 4.11 历史记录列表
- **显示内容**：每条记录包含"回合X [方向图标] 诗句内容"
- **排序方式**：最新记录在顶部
- **自动滚动**：新增记录时自动滚动到顶部
- **方向图标**：横向显示"→"，纵向显示"↓"

## 5. 数据约定

### 5.1 本地存储Key
- **scjl_poems**：存储所有诗句数据
- **scjl_turn**：存储当前回合数
- **scjl_cells**：存储单元格映射数据

### 5.2 数据结构

#### poems 数组
```javascript
poems: [
  {
    text: string,      // 诗句内容，如"春江潮水连海平"
    x: number,         // 首字所在列的x坐标（网格坐标）
    y: number,         // 首字所在行的y坐标（网格坐标）
    direction: "H"|"V", // 方向：H横向，V纵向
    turn: number       // 回合号，从1开始
  }
]
```

#### cells Map
```javascript
cells: Map<string, {
  char: string,        // 汉字内容
  poemIndex: number,   // 所属诗句在poems数组中的索引
  charIndex: number    // 在诗句中的字符索引
}>
// Map key格式: "x,y"
```

#### draft 草稿对象
```javascript
draft: {
  anchorX: number,     // 连接点的x坐标（网格坐标）
  anchorY: number,     // 连接点的y坐标（网格坐标）
  anchorChar: string,  // 连接点的汉字
  direction: "H"|"V",  // 草稿方向
  text: string,        // 草稿诗句内容
  offset: number,      // 连接点在诗句中的偏移量（0表示首字）
  cells: Array<{       // 草稿占据的单元格数组
    x: number,
    y: number,
    char: string,
    isConflict: boolean // 是否与已有单元格冲突
  }>
}
```

### 5.3 坐标系统约定
- **单元格尺寸**：60px × 60px
- **虚拟地图尺寸**：200000px × 200000px
- **虚拟坐标范围**：x: [-100000, 100000]，y: [-100000, 100000]
- **初始中心**：(0, 0)
- **首句位置**：首字在(0, 0)，横向放置
- **视图坐标**：使用CSS transform translate/scale实现

## 6. 验收标准

### 6.1 初始化功能
- **通过条件**：
  - 打开应用后自动显示首句"春江潮水连海平"（横向，白色背景，灰色边框）
  - 回合数显示为"1"
  - 诗句数显示为"1"
  - 状态标签显示"选择连接点"
  - 底部草稿操作栏隐藏
  - 视角聚焦在首句中心
  - 首句的每个汉字均可悬停显示方向选择器

### 6.2 方向选择功能
- **通过条件**：
  - 鼠标悬停在首句任意汉字上时，显示四个方向箭头围绕该字
  - 点击箭头后立即进入草稿模式
  - 草稿方向与箭头方向一致
  - 鼠标移开后方向选择器消失（进入草稿模式前）

### 6.3 草稿模式功能
- **通过条件**：
  - 进入草稿模式后状态标签更新为"编辑诗句"
  - 底部草稿操作栏显示
  - 输入框自动获取焦点
  - 连接锚点显示蓝色边框高亮
  - 视角自动聚焦到连接点位置
  - 草稿模式下禁用拖拽平移

### 6.4 输入与预览功能
- **通过条件**：
  - 在输入框输入汉字后，方格中实时显示草稿预览（黄色背景）
  - 草稿位置根据连接点、方向、offset=0计算
  - 输入为空时草稿预览清空
  - 输入超过20字时禁止继续输入
  - 允许输入中文、标点、空格

### 6.5 验证功能
- **通过条件**：
  - **有效连接**：输入与现有诗句有1个以上重合字且字符一致时，重合字显示绿色高亮，确认按钮启用
  - **冲突检测**：重合位置字符不一致时，冲突字显示红色高亮，确认按钮保持禁用
  - **无重合点**：输入诗句与现有诗句无重合时，确认按钮保持禁用
  - **全是已有字**：输入诗句所有字都已被占用时，确认按钮保持禁用
  - **空输入**：输入框为空时，确认按钮保持禁用

### 6.6 旋转功能
- **通过条件**：
  - 点击旋转按钮后，草稿方向在横向和纵向之间切换
  - 切换后草稿预览位置重新计算并渲染
  - 方向图标实时更新

### 6.7 提交功能
- **通过条件**：
  - 点击确认按钮且验证通过时：
    - 诗句以白色背景、灰色边框固定到版图
    - 回合数+1
    - 诗句数+1
    - 历史记录新增一条（回合号、方向、内容）
    - 退出草稿模式
    - 状态标签更新为"选择连接点"
    - 底部草稿操作栏隐藏
  - 点击确认按钮且验证失败时，保持草稿模式

### 6.8 取消功能
- **通过条件**：
  - 点击取消按钮后：
    - 草稿数据清空
    - 草稿预览消失
    - 退出草稿模式
    - 状态标签更新为"选择连接点"
    - 底部草稿操作栏隐藏

### 6.9 地图操作功能
- **通过条件**：
  - **拖拽平移**：非草稿模式下鼠标左键拖拽可移动视角，草稿模式下拖拽无效
  - **滚轮缩放**：鼠标滚轮可缩放视角，范围0.3x-3x，以鼠标位置为中心
  - **重置视图**：点击重置视图按钮后，视角回到最后放置诗句中心或初始中心

### 6.10 历史记录功能
- **通过条件**：
  - 提交新诗句后历史记录列表新增一条记录
  - 记录格式为"回合X [方向图标] 诗句内容"
  - 最新记录显示在顶部
  - 新增记录后列表自动滚动到顶部

### 6.11 清空所有功能
- **通过条件**：
  - 点击清空所有按钮后弹出确认对话框
  - 点击确认后游戏重置到初始状态（首句"春江潮水连海平"，回合1，诗句1）
  - 点击取消后关闭对话框，不执行清空

### 6.12 多重合点功能
- **通过条件**：
  - 输入诗句与多条现有诗句产生多个重合点时，所有有效重合字显示绿色高亮
  - 所有重合点字符一致时确认按钮启用
  - 任意重合点字符不一致时冲突字显示红色高亮，确认按钮禁用

## 7. 里程碑

### 7.1 MVP（最小可行版本）
1. 无限方格画布渲染（浅灰色网格线，60px单元格）
2. 初始化首句"春江潮水连海平"（横向，中心位置）
3. 悬停汉字显示方向选择器（上下左右箭头）
4. 点击方向进入草稿模式
5. 草稿输入框与实时预览（黄色背景）
6. 基本验证：重合点字符一致检查
7. 确认提交诗句到版图（白色背景）
8. 回合数和诗句数统计显示

### 7.2 完整功能版本
1. 视觉反馈：有效重合字绿色、冲突字红色、连接锚点蓝色
2. 旋转按钮切换方向
3. 拖拽平移视角
4. 滚轮缩放（0.3x-3x）
5. 重置视图按钮
6. 历史记录面板（列表显示、自动滚动）
7. 清空所有功能（二次确认）
8. 取消草稿功能

### 7.3 优化版本
1. 输入框maxlength限制（20字）
2. trim处理和输入过滤
3. 草稿模式禁用拖拽
4. 视角自动聚焦连接点
5. 失焦处理（保持草稿状态）
6. 无重合点检测
7. 全是已有字检测
8. 多重合点支持
